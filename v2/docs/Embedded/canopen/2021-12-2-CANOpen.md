---
title: ğŸµç§»æ¤ç¯‡ï¼šæºç ç§»æ¤
sidebar_position: 4
---

## æ‹·è´æºç æ–‡ä»¶  
åœ¨ç›®æ ‡å·¥ç¨‹ä¸‹å»ºç«‹CANOpenæ–‡ä»¶å¤¹ï¼Œæ–°å»ºCANOpen/srcï¼ŒCANOpen/incï¼ŒCANOpen/driveræ–‡ä»¶å¤¹ã€‚æ–°å»ºdriver/can_timer.cã€driver/can_driver.cã€‚  
* å°†æºç CanFestival-3/srcä¸­dcf.cã€emcy.cã€lifegrd.cã€lss.cã€nmtMaster.cã€nmtSlave.cã€objacces.cã€pdo.cã€sdo.cã€states.cã€sync.cã€timer.cå…±12ä¸ªæ–‡ä»¶æ–‡ä»¶æ‹·è´åˆ°CANOpen/srcã€‚  
  ![0.1](/img/can/0.1.png)   

* å°†æºç CanFestival-3/includeä¸­.hæ–‡ä»¶æ‹·è´åˆ°CANOpen/incã€‚å°†CanFestival-3-10\include\AVRç›®å½•ä¸‹çš„applicfg.hã€canfestival.hã€config.hã€timerscfg.hå…±4ä¸ªå¤´æ–‡ä»¶æ‹·è´åˆ°CANOpen/incç›®å½•ä¸‹ï¼›  
  ç”±äºFREERTOSæºç ä¸­åŒ…å«äº†ä¸canfestivalåŒåçš„timers.cå’Œtimers.hï¼Œå¯ä»¥å°†canfestivalä¸­çš„æ”¹ä¸ºtimer.c/.hä»¥å…å†²çªã€‚  
  ![0.2](/img/can/0.2.png)   

* å°†å­—å…¸æ–‡ä»¶æ‹·è´åˆ°driverç›®å½•ä¸‹  

* æ–°å»ºCO_slave.cï¼Œè®¾ç½®å›è°ƒå‡½æ•°  

  ```
  * CO_Data *OD_Data = &SillySlave_Data;//SillySlave_Dataåœ¨å­—å…¸.cæœ€åä¸€è¡Œ
  
  void CO_slave_initialisation(CO_Data *d)
  {

  }
  
  void CO_slave_preOperational(CO_Data *d)
  {
      printf("CO_slave_preOperational\n");
  }
  
  void CO_slave_operational(CO_Data *d)
  {
      printf("CO_slave_operational\n");
  }
  
  void CO_slave_stopped(CO_Data *d)
  {
      printf("CO_slave_stopped\n");
  }
  
  void CO_slave_post_sync(CO_Data *d)
  {
      printf("CO_slave_post_sync: \n");
  }
  
  void CO_slave_post_TPDO(CO_Data *d)
  {
      printf("CO_slave_post_TPDO: \n");
      printf("LifeSignal = %u\n", LifeSignal);
  }
  
  void CO_slave_post_emcy(CO_Data *d, UNS8 nodeID, UNS16 errCode, UNS8 errReg, const UNS8 errSpec[5])
  {
      //    printf("Slave received EMCY message. Node: %2.2xh  ErrorCode: %4.4x  ErrorRegister: %2.2xh\n", nodeID, errCode, errReg);
  }
  
  void CO_slave_heartbeatError(CO_Data *d, UNS8 heartbeatID)
  {
      //    printf("CO_slave_heartbeatError %d\n", heartbeatID);
  }
  
  UNS32 CO_slave_storeODSubIndex(CO_Data *d, UNS16 wIndex, UNS8 bSubindex)
  {
      /*TODO : 
       * - call getODEntry for index and subindex, 
       * - save content to file, database, flash, nvram, ...
       * 
       * To ease flash organisation, index of variable to store
       * can be established by scanning d->objdict[d->ObjdictSize]
       * for variables to store.
       * 
       * */
      //    printf("CO_slave_storeODSubIndex : %4.4x %2.2xh\n", wIndex,  bSubindex);
      return 0;
  }
  
  
  int canopen_init(void)
  {
  
      OD_Data->heartbeatError = CO_slave_heartbeatError;
      OD_Data->initialisation = CO_slave_initialisation;
      OD_Data->preOperational = CO_slave_preOperational;
      OD_Data->operational = CO_slave_operational;
      OD_Data->stopped = CO_slave_stopped;
      OD_Data->post_sync = CO_slave_post_sync;
      OD_Data->post_TPDO = CO_slave_post_TPDO;
      OD_Data->storeODSubIndex = (void *)CO_slave_storeODSubIndex;
      OD_Data->post_emcy = (void *)CO_slave_post_emcy;
      
      HAL_TIM_Base_Start_IT(&htim13);//å¼€å¯å®šæ—¶å™¨
      
      setNodeId(OD_Data, NODE_SLAVE);
      setState(OD_Data, Initialisation);
      
      return 0;
  
  }
  ```

  

* åœ¨å·¥ç¨‹ä¸­æ·»åŠ .cæ–‡ä»¶ï¼ŒåŒ…å«.hçš„è·¯å¾„ã€‚  

## ç¼–è¯‘å·¥ç¨‹  
æºç éœ€è¦æˆ‘ä»¬é…ç½®å‡ ä¸ªå‡½æ•°æ¥è¿è¡Œåè®®æ ˆã€‚  
* åœ¨can_timer.cä¸­æ·»åŠ å‡ ä¸ªç©ºå‡½æ•°ã€‚  

  ```
  #include "canfestival.h"
  void setTimer(TIMEVAL value)
  {
  }
  TIMEVAL getElapsedTime(void)
  {
        return 1;
  }
  can_driver.cä¸­æ·»åŠ 
  unsigned char canSend(CAN_PORT notused, Message *m)
  {
        return 1;
  }
  ```

  

* æ³¨é‡Šæˆ–åˆ é™¤æ‰config.hæ–‡ä»¶ä¸­çš„å¦‚ä¸‹å‡ è¡Œï¼š

  ```
  #include <inttypes.h>
  #include <avr\io.h>
  #include <avr\interrupt.h>
  #include <avr/pgmspace.h>
  #include <avr\sleep.h>
  #include <avr\wdt.h>
  ```

  

* è‹¥ç¼–è¯‘æ—¶dcf.cä¸­æŠ¥é”™inlineå†…è”å‡½æ•°æœªå®šä¹‰ï¼Œåªéœ€å£°æ˜ä¸€ä¸‹åŸå‡½æ•°å³å¯ã€‚  
  ![0.3](/img/can/0.3.png)  

* ç¼–è¯‘è§£å†³å…¶ä»–æŠ¥é”™é—®é¢˜ï¼Œç›´è‡³ç¼–è¯‘é€šè¿‡  

## æ¥å£é…ç½®  
ä¸Šæ–¹å®šä¹‰äº†å‡ ä¸ªç©ºå‡½æ•°ï¼Œå‡½æ•°void setTimer(TIMEVAL value)ä¸»è¦è¢«æºç ç”¨æ¥å®šæ—¶çš„ï¼Œæ—¶é—´åˆ°äº†å°±éœ€è¦è°ƒç”¨ä¸€ä¸‹å‡½æ•°TimeDispatch()ï¼Œå‡½æ•°TIMEVAL getElapsedTime(void)ä¸»è¦è¢«æºç ç”¨æ¥æŸ¥è¯¢è·ç¦»ä¸‹ä¸€ä¸ªå®šæ—¶è§¦å‘è¿˜æœ‰å¤šå°‘æ—¶é—´ï¼Œunsigned char canSend(CAN_PORT notused, Message *m)å‡½æ•°ä¸»è¦è¢«æºç ç”¨æ¥å‘ä¸€ä¸ªCANåŒ…çš„ï¼Œéœ€è¦è°ƒç”¨é©±åŠ¨æ¥å°†ä¸€ä¸ªCANåŒ…å‘å‡ºå»ã€‚  
åœ¨can_timer.cä¸­ï¼š    

```
unsigned int TimeCNT=0;//æ—¶é—´è®¡æ•°
unsigned int NextTime=0;//ä¸‹ä¸€æ¬¡è§¦å‘æ—¶é—´è®¡æ•°
unsigned int TIMER_MAX_COUNT=70000;//æœ€å¤§æ—¶é—´è®¡æ•°
static TIMEVAL last_time_set = TIMEVAL_MAX;//ä¸Šä¸€æ¬¡çš„æ—¶é—´è®¡æ•°
setTimerå’ŒgetElapsedTimeå‡½æ•°å®ç°å¦‚ä¸‹ï¼š
//Set the next alarm //
void setTimer(TIMEVAL value)
{
        NextTime=(TimeCNT+value)%TIMER_MAX_COUNT;
}
// Get the elapsed time since the last occured alarm //
TIMEVAL getElapsedTime(void)
{
        int ret=0;
        ret = TimeCNT> last_time_set ? TimeCNT - last_time_set : TimeCNT + TIMER_MAX_COUNT - last_time_set;
        last_time_set = TimeCNT;
        return ret;
}
```

åœ¨1mså®šæ—¶å™¨ä¸­æ–­ä¸­è°ƒç”¨ä»¥ä¸‹å‡½æ•°

```
void timerForCan(void)
{
        TimeCNT++;
        if (TimeCNT>=TIMER_MAX_COUNT)
        {
                TimeCNT=0;
        }
        if (TimeCNT==NextTime)
        {
                TimeDispatch();
        }
}
```



* cansendå°±ä¸å¤šè¯´äº†ï¼Œæ ¹æ®èŠ¯ç‰‡ã€ä¾‹ç¨‹é…ç½®å°±è¡Œäº†ã€‚   

  

* **æ¥ä¸‹æ¥æ¥åˆ°äº†å·¨å‘æ—¶åˆ»ï¼ï¼ï¼ï¼**  
  æŒ‰é“ç†è¯´ä¸Šè¿°æ¥å£é…ç½®å®Œæˆååè®®æ ˆå°±åº”è¯¥è¿è¡Œèµ·æ¥äº†ï¼Œä½†æ˜¯æˆ‘åœ¨å†™è¿™ç¯‡æ—¶å®šæ—¶æ—¶é—´æ€»æ˜¯ä¸å‡†ç¡®ï¼ŒæŠ˜è…¾çš„æˆ‘ç²¾ç¥è¡°å¼±ï¼Œæ— æ•°æ¬¡æ€€ç–‘æ¥å£æ˜¯ä¸æ˜¯å†™é”™äº†ï¼Œå®šæ—¶å™¨æ˜¯ä¸æ˜¯ä¸å‡†ç¡®ï¼Œç”šè‡³è‡ªå·±æ ¹æ®å¤šä¸ªå·¥ç¨‹æ¡ˆä¾‹å†™æ¥å£ï¼Œç›´åˆ°æœ‰ä¸€å¤©çœ‹åˆ°è¯„è®ºåŒºä¸€ä½æ•‘å‘½æ©äººè¯´timerscfg.hä¸‹çš„`MS_TO_TIMEVAL`å’Œ`US_TO_TIMEVAL`éœ€è¦æ ¹æ®å®šæ—¶æƒ…å†µæ›´æ”¹ã€‚ç„¶åæˆ‘ç«‹åˆ»æŸ¥çœ‹äº†å·¥ç¨‹ï¼Œæœç„¶canfestivalæºç ä¸­å®šä¹‰çš„æ˜¯  

  ```
  // The timer is incrementing every 8 us.
  #define MS_TO_TIMEVAL(ms) ((ms) * 125)
  #define US_TO_TIMEVAL(us) ((us)>>3)
  ```

  æ„æ€æ˜¯æ—¶é’Ÿæ¯ä¸¤æ¬¡ä¸­æ–­ä¹‹é—´æ—¶é—´é—´éš”ä¸º8usï¼Œç„¶è€Œæˆ‘ä»¬çš„å®šæ—¶å™¨æ˜¯1msï¼Œå°†å…¶æ”¹ä¸º  

  ```
  // The timer is incrementing every 1000 us.
  #define MS_TO_TIMEVAL(ms) ((ms) * 1)
  #define US_TO_TIMEVAL(us) ((us)/1000)
  ```

  å®Œç¾è¿è¡Œï¼ï¼ï¼  
  åœ¨æ­¤å‘Šè¯«è‡ªå·±é‡åˆ°é—®é¢˜è¿˜æ˜¯è¦ä¸é™èŒƒå›´æœç´¢èµ„æ–™ï¼Œ**åŒæ—¶åšå¥½å·¥ä½œç¬”è®°**ï¼Œä»¥å…ä»¥åå†ç”¨æ—¶åˆå¾—ä»å¤´å†æ¥ï¼Œæµªè´¹é’æ˜¥
