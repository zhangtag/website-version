---
id: 2022-5-7-k8s-Manually
description: æ‰‹åŠ¨å®‰è£…
# slug: åŸç†ç¯‡ï¼šCANä¸CANOpenåŸºç¡€
title: ğŸ æ‰‹åŠ¨å®‰è£…
sidebar_position: 4
# tags:
#     - P 1.3
   #  - Work needed
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import Thumbnail from "@site/src/components/Thumbnail";

:::info

å¹³å°ï¼šUbuntu18.04/20.04

:::


## [è®¾ç½®é™æ€IP/ä¿®æ”¹hostsåç§°](https://www.zhangshitao.top/2022-5-7-staticIP)

æ–¹ä¾¿èŠ‚ç‚¹ç»Ÿä¸€åŒ–ç®¡ç†




## å®‰è£…Docker

å‚è€ƒ[é“¾æ¥](https://www.zhangshitao.top/2022-3-9-edgex-env)



## é€‰æ‹©ä½ è¦éƒ¨ç½²çš„ç±»å‹ğŸ‘‡




<Tabs className="api-tabs">
<TabItem value="master" label="master">



## k8så®‰è£…

### å…³é—­é˜²ç«å¢™

```shell
sudo ufw disable
```

### å…³é—­selinux

```shell
sudo apt install selinux-utils
sudo setenforce 0
```

### ç¦æ­¢swapåˆ†åŒº

```shell
sudo swapoff -a
sudo gedit /etc/fstab		æ³¨é‡Šæ‰swapä¸€è¡Œ
```

### ç™»é™†rootç”¨æˆ·ï¼š

### æ¡¥æ¥çš„IPV4æµé‡ä¼ é€’åˆ°iptables çš„é“¾

```shell
cat > /etc/sysctl.d/k8s.conf <<EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sysctl --system #ç”Ÿæ•ˆ
```

### é…ç½®k8sèµ„æº

```shell
curl -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -

echo "deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main" >/etc/apt/sources.list.d/kubernetes.list

apt-get update
```

### å®‰è£…kubeadm(åˆå§‹åŒ–cluster)ï¼Œkubelet(å¯åŠ¨pod)å’Œkubectl(k8så‘½ä»¤å·¥å…·)

```shell
sudo apt-get install -y kubelet=1.22.6-00 kubeadm=1.22.6-00 kubectl=1.22.6-00
```

### è®¾ç½®å¼€æœºå¯åŠ¨å¹¶å¯åŠ¨kubelet

```shell
systemctl enable kubelet && systemctl start kubelet
```

### åˆå§‹åŒ–é›†ç¾¤

```shell
kubeadm config images pull 
kubeadm init --image-repository=registry.aliyuncs.com/google_containers  --pod-network-cidr=10.244.0.0/16	 --service-cidr=10.96.0.0/12
```

### è®°å½•joinå¹¶åœ¨ä»èŠ‚ç‚¹æ‰§è¡Œè¿™å¥è¯

```shell
kubeadm join 172.16.206.13:6443 --token 9pslv8.6tbrux0ksur0wgav --discovery-token-ca-cert-hash sha256:3709a3ce5a0ec819308d97a97c445a0414b0ed07a855cb3f948c288f38c7e35c 
```

- è‹¥æ²¡æœ‰è®°å½•ï¼Œä¹Ÿå¯åœ¨masterèŠ‚ç‚¹ç”¨ä»¥ä¸‹æ“ä½œè·å–ï¼š`kubeadm token create --print-join-command`

### ä½¿èƒ½kubectl

```shell
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

### ç½‘ç»œæ’ä»¶

```shell
sudo kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
```

- å¦‚æœæŠ¥é”™ï¼Œæµè§ˆå™¨æ‰“å¼€ç½‘ç«™å¤åˆ¶åˆ°æ–°å»ºæœ¬åœ°æ–‡æœ¬`kube-flannel.yml`ï¼Œæ‰§è¡Œ`sudo kubectl apply -f kube-flannel.yml`

### æŸ¥è¯¢ç»„ä»¶çŠ¶æ€

```shell
kubectl get cs
```

### è§£å†³ç»„ä»¶çŠ¶æ€Unhealthy

- éœ€è¦ç”¨#æ³¨é‡Šæ‰`/etc/kubernetes/manifests`ä¸‹çš„`kube-controller-manager.yamlå’Œkube-scheduler.yamlçš„- â€“ port=0`

### æ³¨é‡Šå®Œåé‡å¯æœåŠ¡

```shell
systemctl restart kubelet.service
```

### å†æ¬¡æŸ¥çœ‹ç»„ä»¶çŠ¶æ€ï¼ˆéœ€è¦ç¨ç­‰ï¼‰

```shell
kubectl get cs
```

## æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€

```shell
kubectl get node
```


### æŸ¥çœ‹podçŠ¶æ€

```shell
kubectl get pod -n kube-system -o wide 
```

- è‹¥flannelæ²¡èµ·æ¥åˆ™æŸ¥çœ‹å…¶æ—¥å¿—ï¼š

```shell
kubectl -n kube-system logs kube-flannel-ds-g59k5
kubectl describe node ubuntu02ï½œgrep cider
```


```shell
kubeadm reset
```

**--------------------------------------------------ä¸‹é¢æ˜¯Kuboard----------------------------------------------------**

## Kuboardä½¿ç”¨ hostPath æä¾›æŒä¹…åŒ–å­˜å‚¨

### Kuboard v3 åœ¨ K8S ä¸­çš„å®‰è£…ï¼ˆä¸»ï¼‰

```shell
kubectl apply -f https://addons.kuboard.cn/kuboard/kuboard-v3-swr.yaml
```

### ç­‰å¾… Kuboard v3 å°±ç»ª

```shell
watch kubectl get pods -n kuboard
```

### è®¿é—®Kuboard

```shell
ç½‘å€ï¼šlocalhost:30080
ç”¨æˆ·åï¼šadmin
å¯†ç ï¼šKuboard123
```

## Kuboard NFS

### åœ¨masterèŠ‚ç‚¹ä¸­å®‰è£…nfsæœåŠ¡å™¨ç«¯

```shell
sudo apt-get install nfs-kernel-server
```

### å…±äº«ç›®å½•é…ç½®æ–‡ä»¶

```shell
sudo mkdir -p ./mnt/nfs
sudo gedit /etc/exports
```

- å†ä¸Šé¢æ–‡ä»¶ä¸­æ·»åŠ ï¼š`/mnt/nfs *(rw,sync,no_root_squash)`  # æ‰‹åŠ¨æ›¿æ¢$USERä¸ºç”¨æˆ·å


```shell
sudo exportfs -arv
```

### å¯åŠ¨NFSæœåŠ¡

```shell
sudo /etc/init.d/nfs-kernel-server restart
```

### æŸ¥çœ‹

~~~shell
df -h /mnt/nfs/
~~~

</TabItem>
<TabItem value="worker" label="worker">


## å®‰è£…nfs

```shell
apt-get install nfs-common -y
```

```shell
sudo gedit /etc/exports
192.168.1.200:/mnt/nfa  /mnt/nfs nfs rw 0 0
```

## å®‰è£…Kubernetes

èµ„æºè¶³å¤Ÿå¯è£…k8sï¼Œå¦åˆ™k3s

:::info
å¦‚æœéœ€è¦åŠ å…¥é›†ç¾¤ï¼Œéœ€è¦å°†masterçš„/etc/kubernetes/admin.confæ‹·è´åˆ°workerä¸­ï¼Œç„¶åworkerèŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å³å¯ä½¿ç”¨kubectl

~~~shell
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
~~~

:::

### k3s 

~~~shell
curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn INSTALL_K3S_VERSION=v1.22.5+k3s1 INSTALL_K3S_EXEC="--no-deploy traefik --no-deploy local-storage --docker --write-kubeconfig ~/.kube/config --write-kubeconfig-mode 666" sh -
~~~

### k8s

:::caution

å‚ç…§ä¸Šä¸€ç¯‡å®‰è£…k8såªéœ€è¿›è¡Œåˆ°è®¾ç½®'å¼€æœºå¯åŠ¨å¹¶å¯åŠ¨kubelet'æ­¥éª¤ï¼Œä¸è¦åˆå§‹åŒ–é›†ç¾¤ã€‚

```shell
# åŠ å…¥é›†ç¾¤
kubeadm token create --print-join-command # masteræ‰§è¡Œè·å–å‘½ä»¤
sudo kubeadm join 172.16.206.13:6443 --token 9pslv8.6tbrux0ksur0wgav --discovery-token-ca-cert-hash sha256:3709a3ce5a0ec819308d97a97c445a0414b0ed07a855cb3f948c288f38c7e35c # workeræ‰§è¡Œå³å¯åŠ å…¥masteré›†ç¾¤
```

:::


</TabItem>
</Tabs>



